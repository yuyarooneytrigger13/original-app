

<div class="main-container">
  <div class="header-area">
    <h1>日程調整表</h1>
  </div>

  <div class="members-section">
    <h4 class="members-title">参加メンバー (<%= @users.count %>名)</h4>
    <div class="members-list">
      <% @users.each do |user| %>
        <div class="member-badge">
          <div class="member-icon"><%= user.nickname.to_s.first.upcase %></div>
          <span class="member-name"><%= user.nickname %></span>
        </div>
      <% end %>
    </div>
  </div>
    
    <div class="action-area">
    <div class="add-candidate-form">
      <%= form_with model: [@plan, @new_candidate], local: true, class: "candidate-form" do |f| %>
        <%= f.date_field :date, class: "form-control date-input", required: true %>
        <%= f.submit "候補日を追加", class: "btn-secondary" %>
      <% end %>
      <%= link_to "このプランに友達を招待", new_user_invitation_path(plan_id: @plan.id), class: "btn" %>
    </div>

    <%= link_to edit_plan_availability_path(@plan, 0), class: "btn-primary" do %>
      <i class="fa-solid fa-pen-to-square"></i> 回答を入力する
    <% end %>
    </div>

  <% if @perfect_candidates.present? %>
    <div class="perfect-list">
      <h3><i class="fa-solid fa-crown"></i> 全員行ける日！</h3>
      <ul>
        <% @perfect_candidates.each do |candidate| %>
          <li class="perfect-item">
            <%= link_to plan_schedules_path(@plan, date: candidate.date), class: "perfect-date-link" do %>
              <%= candidate.date.strftime("%-m/%-d") %> (<%= %w(日 月 火 水 木 金 土)[candidate.date.wday] %>) <i class="fa-solid fa-chevron-right" style="font-size: 0.8em; margin-left: 5px;"></i>
            <% end %>
            <%= link_to "この日程で確定", plan_path(@plan, plan: { confirmed_date: candidate.date }), data: { turbo_method: :patch, turbo_confirm: "#{candidate.date.strftime('%-m/%-d')}で日程を確定しますか？" }, class: "btn-secondary btn-confirm-date" %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= month_calendar(events: @candidates, attribute: :date) do |date, candidates| %>
    <div class="date-cell">
      <div class="date-number">
        <%= link_to date.day, plan_path(@plan, plan: { confirmed_date: date }), data: { turbo_method: :patch, turbo_confirm: "#{date.strftime('%-m/%-d')}で日程を確定しますか？" }, class: "calendar-date-link", title: "この日で確定" %>
      </div>
    </div>
    <% if candidates.any? %>
      <% candidates = candidates.first%>
      <% ok_count = candidates.availabilities.select { |a| a.status == "ok" }.count %>
      <% member_count = @users.count > 0 ? @users.count : 1 %>

      <% box_class = if ok_count == member_count 
       "rank-perfect"
       elsif ok_count >= (member_count / 2.0)
        "rank-good"
        else
        "rank-bad"
        end %>
      <div class="event-box <%= box_class %>">
        <%= link_to edit_plan_availability_path(@plan, 0, anchor: "candidate-#{candidates.id}"), class: "calendar-event-link" do %>
          <div class="match-info">
            
            <% if ok_count == member_count %>
              <i class="fa-solid fa-crown"></i>
            <% end %>
            <span class="count"><%= ok_count %></span> / <%= member_count %>
          </div> 
      <div class="member-dots">
            <% @users.each do |user| %>
              <% status = candidates.availabilities.find { |a| a.user_id == user.id }&.status %>
              
              <span class="dot <%= status %>" title="<%= user.nickname %>"></span>
            <% end %>
          </div>
        <% end %>
      <!-- 削除ボタン -->
          <%= link_to plan_candidate_path(@plan, candidates), 
              data: { turbo_method: :delete, turbo_confirm: "削除しますか？" }, 
              class: "remove-btn" do %>
            ×
          <% end %>
        
      </div>
    <% end%>  


  <% end %>
  <div class="footer-link">
    <%= link_to "メニューに戻る", plan_path(@plan) %>
  </div>
</div>
